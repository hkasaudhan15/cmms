<!DOCTYPE html>
<html>
<head>
    <title>Maintenances</title>
    <link rel="stylesheet" href="/style/style.css">
    <style>
        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .popup-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 85%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .button-group {
            margin: 10px 0;
        }
        
        button, .btn {
            padding: 10px 18px;
            margin: 5px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover, .btn:hover {
            background-color: #0056b3;
        }
        
        .add-btn {
            background-color: #28a745;
        }
        
        .add-btn:hover {
            background-color: #218838;
        }
        
        .schedule-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        select[multiple] {
            height: auto;
            min-height: 100px;
            padding: 5px;
        }
    </style>
</head>
<body>
<h1>Maintenances for Asset {{.AssetLabel}}</h1>

<div class="button-group" style="text-align: right;">
    <button class="add-btn" onclick="openPopup('add-maintenance')">Add New Maintenance</button>
</div>

<!-- Display success/error messages if any -->
{{if .Message}}
    <div class="message {{.MessageType}}">{{.Message}}</div>
{{end}}

{{if .Items}}
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>Maintenance Label</th>
                <th>Number of Schedules</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {{range .Items}}
            <tr>
                <td>{{.Lable}}</td>
                <td>{{len .Shedules}}</td>
                <td>
                    <button onclick="openPopup('view-{{.ID.Hex}}')">View</button>
                    <button onclick="openPopup('edit-{{.ID.Hex}}')">Edit</button>
                    <button onclick="openPopup('delete-{{.ID.Hex}}')">Delete</button>
                    <button onclick="openPopup('add-schedule-{{.ID.Hex}}')">Add Schedule</button>
                </td>
            </tr>
            
            <!-- View Popup -->
            <div id="view-{{.ID.Hex}}" class="popup">
                <div class="popup-content">
                    <span class="close" onclick="closePopup('view-{{.ID.Hex}}')">&times;</span>
                    <h2>View Maintenance: {{.Lable}}</h2>
                    <p><strong>Number of Schedules:</strong> {{len .Shedules}}</p>
                    <h3>Schedules:</h3>
                    {{if .Shedules}}
                        {{range .Shedules}}
                            <div class="schedule-item">
                                <h4>{{.Lable}}</h4>
                                <p><strong>Type:</strong> {{.SheduleType}}</p>
                                <p><strong>Days:</strong> {{.Days}}</p>
                                <p><strong>Notes:</strong> {{.Notes}}</p>
                                {{if .Services}}
                                    <p><strong>Services:</strong></p>
                                    <ul>
                                        {{range .Services}}
                                            <li>{{index $.ServiceNames .Hex}}</li>
                                        {{end}}
                                    </ul>
                                {{end}}
                                {{if .Consumables}}
                                    <p><strong>Consumables:</strong></p>
                                    <ul>
                                        {{range .Consumables}}
                                            <li>{{index $.ConsumableNames .Hex}}</li>
                                        {{end}}
                                    </ul>
                                {{end}}
                            </div>
                        {{end}}
                    {{else}}
                        <p>No schedules found.</p>
                    {{end}}
                </div>
            </div>
            
            <!-- Edit Popup -->
            <div id="edit-{{.ID.Hex}}" class="popup">
                <div class="popup-content">
                    <span class="close" onclick="closePopup('edit-{{.ID.Hex}}')">&times;</span>
                    <h2>Edit Maintenance</h2>
                    <form method="POST" action="/maintenances/edit">
                        <input type="hidden" name="id" value="{{.ID.Hex}}">
                        <div class="form-group">
                            <label for="label">Label:</label>
                            <input type="text" id="label-{{.ID.Hex}}" name="label" value="{{.Lable}}" required>
                        </div>
                        <button type="submit" class="btn">Save Changes</button>
                        <button type="button" class="btn" onclick="closePopup('edit-{{.ID.Hex}}')">Cancel</button>
                    </form>
                </div>
            </div>
            
            <!-- Delete Popup -->
            <div id="delete-{{.ID.Hex}}" class="popup">
                <div class="popup-content">
                    <span class="close" onclick="closePopup('delete-{{.ID.Hex}}')">&times;</span>
                    <h2>Delete Maintenance</h2>
                    <p>Are you sure you want to delete <strong>{{.Lable}}</strong>?</p>
                    <form method="POST" action="/maintenances/delete">
                        <input type="hidden" name="id" value="{{.ID.Hex}}">
                        <button type="submit" class="btn">Yes, Delete</button>
                        <button type="button" class="btn" onclick="closePopup('delete-{{.ID.Hex}}')">Cancel</button>
                    </form>
                </div>
            </div>
            
            <!-- Add Schedule Popup -->
            <div id="add-schedule-{{.ID.Hex}}" class="popup">
                <div class="popup-content">
                    <span class="close" onclick="closePopup('add-schedule-{{.ID.Hex}}')">&times;</span>
                    <h2>Add Schedule to {{.Lable}}</h2>
                    <form method="POST" action="/shedules/add">
                        <input type="hidden" name="id" value="{{.ID.Hex}}">
                        <div class="form-group">
                            <label for="schedule_label">Label:</label>
                            <input type="text" id="schedule_label-{{.ID.Hex}}" name="label" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="shedule_type">Schedule Type:</label>
                                <select id="shedule_type-{{.ID.Hex}}" name="shedule_type" required>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="days">Days:</label>
                                <input type="number" id="days-{{.ID.Hex}}" name="days" min="1" required>
                            </div>
                        </div>
                        
                        <!-- Services dropdown -->
                        <div class="form-group">
                            <label for="services">Services:</label>
                            <select id="services-{{.ID.Hex}}" name="services[]" multiple size="4">
                                {{range $.Services}}
                                    <option value="{{.ID.Hex}}">{{.Label}}</option>
                                {{end}}
                            </select>
                        </div>
                        
                        <!-- Consumables dropdown -->
                        <div class="form-group">
                            <label for="consumables">Consumables:</label>
                            <select id="consumables-{{.ID.Hex}}" name="consumables[]" multiple size="4">
                                {{range $.Consumables}}
                                    <option value="{{.ID.Hex}}">{{.Label}}</option>
                                {{end}}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Notes:</label>
                            <textarea id="notes-{{.ID.Hex}}" name="notes" rows="3"></textarea>
                        </div>
                        
                        <button type="submit" class="btn">Add Schedule</button>
                        <button type="button" class="btn" onclick="closePopup('add-schedule-{{.ID.Hex}}')">Cancel</button>
                    </form>
                </div>
            </div>
        {{end}}
        </tbody>
    </table>
{{else}}
    <p>No maintenance schedules found for this asset.</p>
    <div style="text-align: right;">
        <button class="add-btn" onclick="openPopup('add-maintenance')">Add New Maintenance</button>
    </div>
{{end}}

<!-- Add Maintenance Popup -->
<div id="add-maintenance" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closePopup('add-maintenance')">&times;</span>
        <h2>Add New Maintenance</h2>
        <form method="POST" action="/maintenances/create?asset_id={{.AssetID}}">
            <div class="form-group">
                <label for="maintenance_label">Label:</label>
                <input type="text" id="maintenance_label" name="label" required>
            </div>
            <input type="hidden" name="asset_id" value="{{.AssetID}}">
            <button type="submit" class="btn">Save Maintenance</button>
            <button type="button" class="btn" onclick="closePopup('add-maintenance')">Cancel</button>
        </form>
    </div>
</div>

<script>
    
    function openPopup(popupId) {
        document.getElementById(popupId).style.display = "block";
    }
    
    function closePopup(popupId) {
        document.getElementById(popupId).style.display = "none";
    }
    
    // Close popup when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('popup')) {
            event.target.style.display = "none";
        }
    });
    
    // Close popup with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const openPopups = document.querySelectorAll('.popup[style*="block"]');
            openPopups.forEach(popup => {
                popup.style.display = "none";
            });
        }
    });
</script>

</body>
</html>